<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Motion Analytics - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
        <header class="bg-blue-900 p-6 text-white">
            <h1 class="text-2xl font-bold">Prima Motion: Biomechanics Analyzer</h1>
            <p class="opacity-80">Professional Force Plate Analysis (Fixed Data Engine)</p>
        </header>

        <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <label class="block font-bold text-blue-900 mb-2">1. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</label>
                    <select id="analysisType" class="w-full p-2 border rounded bg-white">
                        <option value="CMJ">Countermovement Jump (CMJ)</option>
                        <option value="DJ">Drop Jump (DJ)</option>
                    </select>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <label class="block font-bold text-blue-900 mb-2">2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</label>
                    <input type="file" id="fileInput" accept=".csv" class="w-full text-sm">
                    <div id="status" class="mt-3 text-xs font-bold uppercase tracking-wider"></div>
                </div>
                
                <button id="exportBtn" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hidden shadow-lg hover:bg-emerald-700 transition-all">
                    üì• DOWNLOAD RESULTS
                </button>
            </div>

            <div class="md:col-span-3 space-y-6">
                <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                <div class="bg-white border rounded-xl p-2 shadow-inner">
                    <div id="chart" class="w-full h-[550px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const statusDisp = document.getElementById('status');
        const exportBtn = document.getElementById('exportBtn');
        let finalCsvData = [];

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏•‡∏µ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 51kN)
        function cleanValue(val) {
            if (val === null || val === undefined) return null;
            let s = val.toString().trim();
            // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á
            let parts = s.split(/\s+/);
            let target = parts[parts.length - 1]; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
            
            let match = target.match(/(-?\d+\.\d+)/);
            if (match) {
                let num = parseFloat(match[1]);
                return Math.abs(num) < 8000 ? num : null; // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏¢‡∏±‡∏á‡πÇ‡∏î‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 8000N
            }
            return null;
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusDisp.className = "mt-3 text-xs font-bold text-orange-500 animate-pulse";
            statusDisp.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processBiomechanics(results.data);
                }
            });
        });

        function processBiomechanics(data) {
            // 1. Clean & Repair
            let cleanData = data.map(row => {
                let f = cleanValue(row['force ']);
                let l = cleanValue(row['left force']);
                let r = cleanValue(row['right force']);
                
                // Cross-repair logic
                if (f === null && l !== null && r !== null) f = l + r;
                if (l === null && f !== null && r !== null) l = f - r;
                if (r === null && f !== null && l !== null) r = f - l;

                return { time: parseFloat(row['time']), total: f, left: l, right: r };
            }).filter(d => !isNaN(d.time) && d.total !== null);

            // 2. VALD Analysis Logic
            const g = 9.80665;
            const dt = cleanData[1].time - cleanData[0].time;
            const bw = cleanData.slice(0, 500).reduce((a, b) => a + b.total, 0) / 500;
            const mass = bw / g;

            // Detection
            let startIdx = cleanData.findIndex(d => Math.abs(d.total - bw) > 20);
            let takeoffIdx = cleanData.findIndex((d, i) => i > startIdx && d.total < 25);
            
            // Integration (Velocity)
            let v = 0, maxV = 0;
            for(let i = startIdx; i <= takeoffIdx; i++) {
                v += ((cleanData[i].total - bw) / mass) * dt;
                if (v > maxV) maxV = v;
            }

            const jh = (Math.pow(maxV, 2) / (2 * g)) * 100;
            const pf = Math.max(...cleanData.map(d => d.total));
            const ct = cleanData[takeoff_idx].time - cleanData[start_idx].time;

            // 3. Update UI
            updateMetrics([
                { label: "Jump Height", val: jh.toFixed(1) + " cm" },
                { label: "Peak Force", val: pf.toFixed(0) + " N" },
                { label: "Body Weight", val: (bw/g).toFixed(1) + " kg" },
                { label: "Contraction Time", val: ct.toFixed(2) + " s" }
            ]);

            // 4. Interactive Plot
            const plotData = [
                { x: cleanData.map(d=>d.time), y: cleanData.map(d=>d.total), name: 'Total Force', line: {color: '#111', width: 2.5} },
                { x: cleanData.map(d=>d.time), y: cleanData.map(d=>d.left), name: 'Left Plate', line: {color: '#2563eb', width: 1.5} },
                { x: cleanData.map(d=>d.time), y: cleanData.map(d=>d.right), name: 'Right Plate', line: {color: '#dc2626', width: 1.5} }
            ];

            Plotly.newPlot('chart', plotData, {
                xaxis: { title: 'Time (seconds)', gridcolor: '#eee' },
                yaxis: { title: 'Force (Newtons)', gridcolor: '#eee' },
                hovermode: 'x unified',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, r: 20 }
            });

            statusDisp.className = "mt-3 text-xs font-bold text-emerald-600";
            statusDisp.innerText = "‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
            exportBtn.classList.remove('hidden');
            
            finalCsvData = [["Metric","Value"], ["Jump Height (cm)",jh], ["Peak Force (N)",pf], ["Body Mass (kg)",bw/g]];
        }

        function updateMetrics(metrics) {
            const container = document.getElementById('metrics');
            container.innerHTML = metrics.map(m => `
                <div class="bg-white border-b-4 border-blue-500 p-4 rounded-xl shadow-md text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-black mb-1">${m.label}</p>
                    <p class="text-2xl font-black text-slate-800">${m.val}</p>
                </div>
            `).join('');
        }

        exportBtn.onclick = () => {
            let csvContent = "data:text/csv;charset=utf-8," + finalCsvData.map(e => e.join(",")).join("\n");
            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Prima_Motion_Report.csv");
            document.body.appendChild(link);
            link.click();
        };
    </script>
</body>
</html>

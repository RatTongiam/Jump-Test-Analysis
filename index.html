<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Motion - Filter Enabled</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-7xl mx-auto py-4 px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <header class="bg-slate-900 p-6 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black tracking-tighter italic">PRIMA MOTION <span class="text-blue-500 text-xs not-italic ml-1">v2.5 PRO FILTER</span></h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Signal Processing & Analytics</p>
                </div>
            </header>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="p-5 bg-slate-100 rounded-2xl border border-slate-200 space-y-4">
                        <div>
                            <label class="block text-[10px] font-black text-blue-600 uppercase mb-2">Signal Filtering (Smoothing)</label>
                            <select id="filterSize" class="w-full p-3 bg-white border border-slate-300 rounded-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">None (Raw Data)</option>
                                <option value="5">Low (5-pt Smooth)</option>
                                <option value="11" selected>Medium (11-pt Smooth)</option>
                                <option value="21">High (21-pt Smooth)</option>
                            </select>
                            <p class="text-[9px] text-slate-400 mt-1">*ช่วยกำจัด Artifacts แหลมๆ ที่ทำให้ค่า Peak เพี้ยน</p>
                        </div>
                        
                        <div class="h-px bg-slate-200"></div>

                        <div>
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Test Type</label>
                            <select id="analysisType" class="w-full p-3 bg-white border border-slate-300 rounded-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="CMJ">Countermovement Jump</option>
                                <option value="DJ">Drop Jump (RSI)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Upload File</label>
                            <input type="file" id="fileInput" accept=".csv" class="w-full text-xs text-slate-400 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-900 file:text-white file:font-black">
                        </div>
                    </div>
                    <button id="exportBtn" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg hidden">DOWNLOAD REPORT</button>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-1 relative shadow-inner">
                        <div id="chart" class="w-full h-[480px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const regex = /(-?\d+\.\d+)/;
        let rawParsedData = [];

        // ฟังก์ชัน Moving Average สำหรับลบ Artifacts
        function movingAverage(data, windowSize) {
            if (windowSize <= 1) return data;
            let result = [];
            let half = Math.floor(windowSize / 2);
            for (let i = 0; i < data.length; i++) {
                let start = Math.max(0, i - half);
                let end = Math.min(data.length, i + half + 1);
                let sum = 0;
                for (let j = start; j < end; j++) {
                    sum += data[j];
                }
                result.push(sum / (end - start));
            }
            return result;
        }

        function parseForce(val) {
            if (!val) return null;
            const parts = val.toString().trim().split(/\s+/);
            const match = parts[parts.length - 1].match(regex);
            return match ? parseFloat(match[1]) : null;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true, worker: true,
                complete: function(results) {
                    rawParsedData = results.data;
                    processWithFilter();
                }
            });
        });

        // สั่งประมวลผลใหม่เมื่อเปลี่ยนค่าฟิลเตอร์
        document.getElementById('filterSize').addEventListener('change', processWithFilter);

        function processWithFilter() {
            if (rawParsedData.length === 0) return;
            
            const windowSize = parseInt(document.getElementById('filterSize').value);
            let times = [], totals = [], lefts = [], rights = [];

            // 1. Clean & Extract
            for (let i = 0; i < rawParsedData.length; i++) {
                const row = rawParsedData[i];
                let f = parseForce(row['force ']);
                let l = parseForce(row['left force']);
                let r = parseForce(row['right force']);
                const t = parseFloat(row['time']);
                if (isNaN(t)) continue;
                
                if (f === null && l !== null && r !== null) f = l + r;
                if (f !== null) {
                    times.push(t);
                    totals.push(f);
                    lefts.push(l || 0);
                    rights.push(r || 0);
                }
            }

            // 2. Apply Smoothing Filter (กำจัด Artifacts)
            const smoothTotals = movingAverage(totals, windowSize);
            const smoothLefts = movingAverage(lefts, windowSize);
            const smoothRights = movingAverage(rights, windowSize);

            // 3. Biomechanics Calculations (ใช้ข้อมูลที่กรองแล้ว)
            const g = 9.80665;
            const dt = times[1] - times[0];
            const bw = smoothTotals.slice(0, 500).reduce((a, b) => a + b, 0) / 500;
            const mass = bw / g;

            let startIdx = 0, takeoffIdx = times.length - 1;
            for(let i=0; i<smoothTotals.length; i++) if(Math.abs(smoothTotals[i]-bw) > 25) { startIdx = i; break; }
            for(let i=startIdx; i<smoothTotals.length; i++) if(smoothTotals[i] < 20) { takeoffIdx = i; break; }

            let v = 0, maxV = 0;
            for(let i=startIdx; i<=takeoffIdx; i++) {
                v += ((smoothTotals[i] - bw) / mass) * dt;
                if(v > maxV) maxV = v;
            }

            const jh = (Math.pow(maxV, 2) / (2 * g)) * 100;
            const peakF = Math.max(...smoothTotals);

            // 4. Update UI
            updateMetrics([
                { label: "Jump Height", val: jh.toFixed(1) + " cm" },
                { label: "Peak Force", val: peakF.toFixed(0) + " N" },
                { label: "Body Mass", val: (bw/g).toFixed(1) + " kg" },
                { label: "Filter Status", val: windowSize > 1 ? "Active" : "Raw" }
            ]);

            // 5. Plotly (ใช้ scattergl เพื่อความลื่น)
            Plotly.newPlot('chart', [
                { x: times, y: totals, name: 'Raw Total', type: 'scattergl', line: {color: '#ddd', width: 1}, opacity: 0.4 },
                { x: times, y: smoothTotals, name: 'Filtered Total', type: 'scattergl', line: {color: '#0f172a', width: 2.5} },
                { x: times, y: smoothLefts, name: 'Left', type: 'scattergl', line: {color: '#3b82f6', width: 1} },
                { x: times, y: smoothRights, name: 'Right', type: 'scattergl', line: {color: '#ef4444', width: 1} }
            ], {
                margin: { t: 10, b: 30, l: 40, r: 10 },
                xaxis: { title: 'Time (s)', gridcolor: '#f1f5f9' },
                yaxis: { title: 'Force (N)', gridcolor: '#f1f5f9' },
                hovermode: 'x unified'
            });
        }

        function updateMetrics(metrics) {
            const container = document.getElementById('metrics');
            container.innerHTML = metrics.map(m => `
                <div class="bg-white border border-slate-200 p-5 rounded-3xl shadow-sm text-center">
                    <p class="text-[9px] text-slate-400 font-black uppercase mb-1">${m.label}</p>
                    <p class="text-xl font-black text-slate-900">${m.val}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>

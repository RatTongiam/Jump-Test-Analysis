<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Motion Pro - Biomechanics Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen font-sans">

    <div class="max-w-7xl mx-auto py-6 px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <header class="bg-slate-900 p-6 text-white flex justify-between items-center border-b-4 border-blue-600">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter">PRIMA MOTION <span class="text-blue-500 not-italic ml-1 text-sm uppercase">PRO V3.0</span></h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Full Movement Phase & Metrics Engine</p>
                </div>
            </header>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-1 space-y-4">
                    <div class="p-6 bg-slate-50 rounded-2xl border border-slate-200 space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-blue-600 uppercase mb-2 italic">Smoothing Filter</label>
                            <select id="filterSize" class="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 transition-all">
                                <option value="1">Raw (No Filter)</option>
                                <option value="7">Soft (7-pt)</option>
                                <option value="13" selected>Medium (13-pt)</option>
                                <option value="25">Hard (25-pt)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Analysis Type</label>
                            <select id="analysisType" class="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold">
                                <option value="CMJ">Countermovement Jump</option>
                                <option value="DJ">Drop Jump (RSI Focus)</option>
                            </select>
                        </div>

                        <div class="h-px bg-slate-200"></div>

                        <div class="space-y-2">
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-1">Upload Data</label>
                            <input type="file" id="fileInput" accept=".csv" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:bg-blue-900 file:text-white file:font-black cursor-pointer">
                        </div>
                    </div>
                    <button id="exportBtn" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg hidden hover:bg-emerald-700 transition-all transform active:scale-95">ðŸ“¥ DOWNLOAD PDF/CSV REPORT</button>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div id="metrics" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3">
                        </div>

                    <div class="bg-white border rounded-2xl p-2 shadow-inner space-y-2">
                        <div id="forceChart" class="w-full h-[380px]"></div>
                        <div class="h-px bg-slate-100 mx-10"></div>
                        <div id="deficitChart" class="w-full h-[220px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const regex = /(-?\d+\.\d+)/;
        let globalRaw = [];

        function movingAverage(d, s) {
            if (s <= 1) return d;
            let res = [], h = Math.floor(s/2);
            for(let i=0; i<d.length; i++){
                let start = Math.max(0, i-h), end = Math.min(d.length, i+h+1);
                let sum = 0; for(let j=start; j<end; j++) sum += d[j];
                res.push(sum/(end-start));
            }
            return res;
        }

        function parseV(v) {
            if(!v) return null;
            let p = v.toString().trim().split(/\s+/).pop();
            let m = p.match(regex);
            return m ? parseFloat(m[1]) : null;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            Papa.parse(f, { header:true, skipEmptyLines:true, worker:true, complete: r => { globalRaw = r.data; run(); }});
        });

        document.getElementById('filterSize').addEventListener('change', run);

        function run() {
            if(!globalRaw.length) return;
            const fSize = parseInt(document.getElementById('filterSize').value);
            
            let t=[], f=[], l=[], r=[];
            globalRaw.forEach(row => {
                let force = parseV(row['force ']), left = parseV(row['left force']), right = parseV(row['right force']), time = parseFloat(row['time']);
                if(!isNaN(time)) { t.push(time); f.push(force || (left+right)); l.push(left || 0); r.push(right || 0); }
            });

            const sf = movingAverage(f, fSize), sl = movingAverage(l, fSize), sr = movingAverage(r, fSize);
            
            // --- Biomechanics Logic ---
            const g = 9.80665, dt = t[1]-t[0];
            const bw = sf.slice(0, 500).reduce((a,b)=>a+b,0)/500;
            const mass = bw/g;

            // Phase Detection
            let sIdx = sf.findIndex(v => Math.abs(v-bw) > 20); // Start of Movement
            let tIdx = sf.findIndex((v,i) => i > sIdx && v < 25); // Take-off
            
            // Calculate Velocity & Displacement
            let velocity = 0, maxV = 0, vArr = [];
            for(let i=0; i<sf.length; i++) {
                if(i >= sIdx && i <= tIdx) {
                    velocity += ((sf[i]-bw)/mass) * dt;
                } else {
                    velocity = 0;
                }
                vArr.push(velocity);
                if(velocity > maxV) maxV = velocity;
            }

            // Phase Separation
            // Eccentric: SOM to Zero Velocity (Moment of max dip)
            // Concentric: Zero Velocity to Take-off
            let zeroVIdx = sIdx;
            let minV = 0;
            for(let i=sIdx; i<tIdx; i++) {
                if(vArr[i] < minV) { minV = vArr[i]; }
                if(i > sIdx && vArr[i-1] < 0 && vArr[i] >= 0) { zeroVIdx = i; break; }
            }

            const jh = (Math.pow(maxV, 2) / (2 * g)) * 100;
            const peakPower = Math.max(...sf.map((f,i) => f * Math.abs(vArr[i])));
            const rsiMod = (jh/100) / (t[tIdx] - t[sIdx]);

            updateMetricsUI([
                { label: "Jump Height", val: jh.toFixed(1)+" cm" },
                { label: "Peak Force", val: Math.max(...sf).toFixed(                        <div class="h-px bg-slate-200"></div>
                        <input type="file" id="fileInput" accept=".csv" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:bg-blue-900 file:text-white file:font-black cursor-pointer">
                    </div>
                    <button id="exportBtn" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg hidden">GENERATE CSV REPORT</button>
                </div>

                <div class="lg:col-span-3 space-y-4">
                    <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    <div class="bg-white border rounded-2xl p-2 shadow-inner">
                        <div id="forceChart" class="w-full h-[320px]"></div>
                        <div id="deficitChart" class="w-full h-[250px] mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const regex = /(-?\d+\.\d+)/;
        let globalRaw = [];

        function movingAverage(d, s) {
            if (s <= 1) return d;
            let res = [], h = Math.floor(s/2);
            for(let i=0; i<d.length; i++){
                let start = Math.max(0, i-h), end = Math.min(d.length, i+h+1);
                let sum = 0; for(let j=start; j<end; j++) sum += d[j];
                res.push(sum/(end-start));
            }
            return res;
        }

        function parseV(v) {
            if(!v) return null;
            let parts = v.toString().trim().split(/\s+/);
            let m = parts[parts.length-1].match(regex);
            return m ? parseFloat(m[1]) : null;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            Papa.parse(f, { header:true, skipEmptyLines:true, worker:true, complete: r => { globalRaw = r.data; run(); }});
        });

        document.getElementById('filterSize').addEventListener('change', run);
        document.getElementById('threshold').addEventListener('input', run);

        function run() {
            if(!globalRaw.length) return;
            const fSize = parseInt(document.getElementById('filterSize').value);
            const limit = parseFloat(document.getElementById('threshold').value);

            let t=[], f=[], l=[], r=[], d=[];
            globalRaw.forEach(row => {
                let force = parseV(row['force ']), left = parseV(row['left force']), right = parseV(row['right force']), time = parseFloat(row['time']);
                if(!isNaN(time)) { t.push(time); f.push(force || (left+right)); l.push(left || 0); r.push(right || 0); }
            });

            const sf = movingAverage(f, fSize), sl = movingAverage(l, fSize), sr = movingAverage(r, fSize);
            
            for(let i=0; i<sf.length; i++) {
                if(sf[i] < 50) { d.push(0); continue; }
                d.push(((sl[i] - sr[i]) / Math.max(sl[i], sr[i])) * 100);
            }

            const g=9.80665, dt=t[1]-t[0], bw=sf.slice(0,500).reduce((a,b)=>a+b,0)/500, m=bw/g;
            let sIdx=sf.findIndex(v=>Math.abs(v-bw)>20), tIdx=sf.findIndex((v,i)=>i>sIdx && v<25);
            let vel=0, maxV=0; for(let i=sIdx; i<=tIdx; i++){ vel+=((sf[i]-bw)/m)*dt; if(vel>maxV) maxV=vel; }

            const propDeficits = d.slice(sIdx, tIdx);
            const peakDeficit = Math.max(...propDeficits.map(Math.abs));

            updateMetricsUI([
                { label: "Jump Height", val: ((maxV**2)/(2*g)*100).toFixed(1)+" cm" },
                { label: "Peak Deficit", val: peakDeficit.toFixed(1)+" %" },
                { label: "Dominance", val: (sl[sf.indexOf(Math.max(...sf))] > sr[sf.indexOf(Math.max(...sf))]) ? "LEFT" : "RIGHT" },
                { label: "Status", val: peakDeficit > limit ? "âš ï¸ REVIEW" : "âœ… STABLE" }
            ]);

            // Chart: Force
            Plotly.newPlot('forceChart', [
                { x:t, y:sl, name:'Left', type:'scattergl', line:{color:'#3b82f6', width:2} },
                { x:t, y:sr, name:'Right', type:'scattergl', line:{color:'#ef4444', width:2} }
            ], { 
                margin:{t:10, b:20, l:50, r:10}, hovermode:'x unified', 
                xaxis:{showticklabels:false, gridcolor:'#f1f5f9'}, yaxis:{title:'Force (N)', gridcolor:'#f1f5f9'}
            });

            // Chart: Deficit (Clean Line, No Fill)
            Plotly.newPlot('deficitChart', [
                { x:t, y:d, name:'Asymmetry %', type:'scattergl', line:{color:'#6366f1', width:2.5} }
            ], { 
                margin:{t:10, b:40, l:50, r:10}, hovermode:'x unified',
                xaxis:{title:'Time (s)', gridcolor:'#f1f5f9'}, 
                yaxis:{title:'L-R Deficit (%)', range:[-50, 50], gridcolor:'#f1f5f9', zeroline:true, zerolinecolor:'#94a3b8', zerolinewidth:2},
                shapes: [{ type:'rect', x0:t[0], x1:t[t.length-1], y0:-limit, y1:limit, fillcolor:'rgba(34,197,94,0.08)', line:{width:0} }]
            });

            const charts = [document.getElementById('forceChart'), document.getElementById('deficitChart')];
            charts.forEach(c => {
                c.on('plotly_hover', data => {
                    let idx = data.points[0].pointIndex;
                    charts.forEach(other => { if(other !== c) Plotly.Fx.hover(other, [{curveNumber:0, pointNumber:idx}]); });
                });
            });
        }

        function updateMetricsUI(m) {
            document.getElementById('metrics').innerHTML = m.map(i => `
                <div class="bg-white border-t-4 ${i.val.includes('âš ï¸')?'border-red-500':'border-blue-500'} p-4 rounded-xl shadow-sm">
                    <p class="text-[9px] text-slate-400 font-black uppercase">${i.label}</p>
                    <p class="text-lg font-black text-slate-800">${i.val}</p>
                </div>`).join('');
        }
    </script>
</body>
</html>                        </div>
                        <div class="h-px bg-slate-200"></div>
                        <input type="file" id="fileInput" accept=".csv" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:bg-blue-900 file:text-white file:font-black">
                    </div>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

                    <div class="bg-white border rounded-2xl p-2 shadow-inner space-y-2">
                        <div id="forceChart" class="w-full h-[350px]"></div>
                        <div class="h-px bg-slate-100 mx-10"></div>
                        <div id="deficitChart" class="w-full h-[250px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const regex = /(-?\d+\.\d+)/;
        let globalData = [];

        function movingAverage(data, size) {
            if (size <= 1) return data;
            let result = [], half = Math.floor(size / 2);
            for (let i = 0; i < data.length; i++) {
                let s = Math.max(0, i - half), e = Math.min(data.length, i + half + 1);
                let sum = 0; for (let j = s; j < e; j++) sum += data[j];
                result.push(sum / (e - s));
            }
            return result;
        }

        function parseVal(v) {
            if(!v) return null;
            let p = v.toString().trim().split(/\s+/).pop();
            let m = p.match(regex);
            return m ? parseFloat(m[1]) : null;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            Papa.parse(f, {
                header: true, skipEmptyLines: true, worker: true,
                complete: res => { globalData = res.data; analyze(); }
            });
        });

        document.getElementById('filterSize').addEventListener('change', analyze);
        document.getElementById('threshold').addEventListener('input', analyze);

        function analyze() {
            if(!globalData.length) return;
            const smoothSize = parseInt(document.getElementById('filterSize').value);
            const limit = parseFloat(document.getElementById('threshold').value);

            let times = [], totals = [], lefts = [], rights = [], deficits = [];

            globalData.forEach(row => {
                let f = parseVal(row['force ']), l = parseVal(row['left force']), r = parseVal(row['right force']), t = parseFloat(row['time']);
                if(!isNaN(t)) {
                    times.push(t); totals.push(f || (l+r)); lefts.push(l || 0); rights.push(r || 0);
                }
            });

            const sT = movingAverage(totals, smoothSize);
            const sL = movingAverage(lefts, smoothSize);
            const sR = movingAverage(rights, smoothSize);

            // Calculate Deficit: (L - R) / max(L, R) * 100
            for(let i=0; i<sT.length; i++) {
                if(sT[i] < 50) { deficits.push(0); continue; } // Filter out flight/quiet noise
                let def = ((sL[i] - sR[i]) / Math.max(sL[i], sR[i])) * 100;
                deficits.push(def);
            }

            // Calculations
            const g = 9.80665, dt = times[1]-times[0];
            const bw = sT.slice(0, 500).reduce((a,b)=>a+b,0)/500;
            const mass = bw/g;
            let sIdx = sT.findIndex(v => Math.abs(v-bw)>20);
            let tIdx = sT.findIndex((v,i) => i>sIdx && v<25);
            
            let v=0, maxV=0;
            for(let i=sIdx; i<=tIdx; i++) { v += ((sT[i]-bw)/mass)*dt; if(v>maxV) maxV=v; }
            
            // Peak Deficit in Propulsion
            const propRange = deficits.slice(sIdx, tIdx);
            const maxDeficit = Math.max(...propRange.map(Math.abs));

            updateUI([
                { label: "Jump Height", val: ((maxV**2)/(2*g)*100).toFixed(1) + " cm" },
                { label: "Mean Deficit", val: (propRange.reduce((a,b)=>a+b,0)/propRange.length).toFixed(1) + " %" },
                { label: "Peak Deficit", val: maxDeficit.toFixed(1) + " %" },
                { label: "Status", val: maxDeficit > limit ? "âš ï¸ ASYMMETRIC" : "âœ… SYMMETRIC" }
            ]);

            // Chart 1: Force
            const forceLayout = {
                margin: {t:20, b:20, l:50, r:20}, hovermode: 'x unified',
                xaxis: { showticklabels: false, gridcolor: '#f1f5f9' },
                yaxis: { title: 'Force (N)', gridcolor: '#f1f5f9' },
                legend: { orientation: 'h', y: 1.1 }
            };
            Plotly.newPlot('forceChart', [
                { x: times, y: sL, name: 'Left', type: 'scattergl', line: {color: '#3b82f6'} },
                { x: times, y: sR, name: 'Right', type: 'scattergl', line: {color: '#ef4444'} }
            ], forceLayout);

            // Chart 2: Deficit Mapping
            const deficitLayout = {
                margin: {t:10, b:40, l:50, r:20}, hovermode: 'x unified',
                xaxis: { title: 'Time (s)', gridcolor: '#f1f5f9' },
                yaxis: { title: 'Deficit L-R (%)', range: [-50, 50], gridcolor: '#f1f5f9' },
                shapes: [
                    { type:'rect', x0:times[0], x1:times[times.length-1], y0:-limit, y1:limit, fillcolor:'rgba(16,185,129,0.1)', line:{width:0} }
                ]
            };
            Plotly.newPlot('deficitChart', [
                { x: times, y: deficits, name: 'Deficit %', type: 'scattergl', line: {color: '#6366f1', width: 2}, fill: 'tozeroy' }
            ], deficitLayout);

            // Link Hover
            const charts = [document.getElementById('forceChart'), document.getElementById('deficitChart')];
            charts.forEach(c => {
                c.on('plotly_hover', d => {
                    let p = d.points[0].pointIndex;
                    charts.forEach(other => { if(other !== c) Plotly.Fx.hover(other, [{curveNumber:0, pointNumber:p}]); });
                });
            });
        }

        function updateUI(m) {
            document.getElementById('metrics').innerHTML = m.map(i => `
                <div class="bg-white border-l-4 ${i.val.includes('âš ï¸') ? 'border-orange-500' : 'border-blue-500'} p-4 rounded-xl shadow-sm">
                    <p class="text-[9px] text-slate-400 font-black uppercase mb-1">${i.label}</p>
                    <p class="text-xl font-black text-slate-800">${i.val}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>

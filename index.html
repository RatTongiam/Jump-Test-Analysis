<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Motion - Deficit Mapping</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-7xl mx-auto py-6 px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <header class="bg-slate-900 p-6 text-white flex justify-between items-center border-b-4 border-blue-600">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter">PRIMA MOTION <span class="text-blue-500 not-italic ml-1 text-sm uppercase">Asymmetry Mapping</span></h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Clinical Deficit Analysis Engine</p>
                </div>
            </header>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="p-5 bg-slate-100 rounded-2xl border border-slate-200 space-y-5">
                        <div>
                            <label class="block text-[10px] font-black text-blue-600 uppercase mb-2">Deficit Threshold (%)</label>
                            <input type="number" id="threshold" value="15" class="w-full p-2 border rounded-lg font-bold text-center">
                            <p class="text-[9px] text-slate-400 mt-1">*Clinical standard: 10-15%</p>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Smoothing</label>
                            <select id="filterSize" class="w-full p-2 border rounded-lg font-bold">
                                <option value="1">Raw</option>
                                <option value="11" selected>Optimal (11-pt)</option>
                                <option value="21">Strong (21-pt)</option>
                            </select>
                        </div>
                        <div class="h-px bg-slate-200"></div>
                        <input type="file" id="fileInput" accept=".csv" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:bg-blue-900 file:text-white file:font-black">
                    </div>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

                    <div class="bg-white border rounded-2xl p-2 shadow-inner space-y-2">
                        <div id="forceChart" class="w-full h-[350px]"></div>
                        <div class="h-px bg-slate-100 mx-10"></div>
                        <div id="deficitChart" class="w-full h-[250px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const regex = /(-?\d+\.\d+)/;
        let globalData = [];

        function movingAverage(data, size) {
            if (size <= 1) return data;
            let result = [], half = Math.floor(size / 2);
            for (let i = 0; i < data.length; i++) {
                let s = Math.max(0, i - half), e = Math.min(data.length, i + half + 1);
                let sum = 0; for (let j = s; j < e; j++) sum += data[j];
                result.push(sum / (e - s));
            }
            return result;
        }

        function parseVal(v) {
            if(!v) return null;
            let p = v.toString().trim().split(/\s+/).pop();
            let m = p.match(regex);
            return m ? parseFloat(m[1]) : null;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if(!f) return;
            Papa.parse(f, {
                header: true, skipEmptyLines: true, worker: true,
                complete: res => { globalData = res.data; analyze(); }
            });
        });

        document.getElementById('filterSize').addEventListener('change', analyze);
        document.getElementById('threshold').addEventListener('input', analyze);

        function analyze() {
            if(!globalData.length) return;
            const smoothSize = parseInt(document.getElementById('filterSize').value);
            const limit = parseFloat(document.getElementById('threshold').value);

            let times = [], totals = [], lefts = [], rights = [], deficits = [];

            globalData.forEach(row => {
                let f = parseVal(row['force ']), l = parseVal(row['left force']), r = parseVal(row['right force']), t = parseFloat(row['time']);
                if(!isNaN(t)) {
                    times.push(t); totals.push(f || (l+r)); lefts.push(l || 0); rights.push(r || 0);
                }
            });

            const sT = movingAverage(totals, smoothSize);
            const sL = movingAverage(lefts, smoothSize);
            const sR = movingAverage(rights, smoothSize);

            // Calculate Deficit: (L - R) / max(L, R) * 100
            for(let i=0; i<sT.length; i++) {
                if(sT[i] < 50) { deficits.push(0); continue; } // Filter out flight/quiet noise
                let def = ((sL[i] - sR[i]) / Math.max(sL[i], sR[i])) * 100;
                deficits.push(def);
            }

            // Calculations
            const g = 9.80665, dt = times[1]-times[0];
            const bw = sT.slice(0, 500).reduce((a,b)=>a+b,0)/500;
            const mass = bw/g;
            let sIdx = sT.findIndex(v => Math.abs(v-bw)>20);
            let tIdx = sT.findIndex((v,i) => i>sIdx && v<25);
            
            let v=0, maxV=0;
            for(let i=sIdx; i<=tIdx; i++) { v += ((sT[i]-bw)/mass)*dt; if(v>maxV) maxV=v; }
            
            // Peak Deficit in Propulsion
            const propRange = deficits.slice(sIdx, tIdx);
            const maxDeficit = Math.max(...propRange.map(Math.abs));

            updateUI([
                { label: "Jump Height", val: ((maxV**2)/(2*g)*100).toFixed(1) + " cm" },
                { label: "Mean Deficit", val: (propRange.reduce((a,b)=>a+b,0)/propRange.length).toFixed(1) + " %" },
                { label: "Peak Deficit", val: maxDeficit.toFixed(1) + " %" },
                { label: "Status", val: maxDeficit > limit ? "⚠️ ASYMMETRIC" : "✅ SYMMETRIC" }
            ]);

            // Chart 1: Force
            const forceLayout = {
                margin: {t:20, b:20, l:50, r:20}, hovermode: 'x unified',
                xaxis: { showticklabels: false, gridcolor: '#f1f5f9' },
                yaxis: { title: 'Force (N)', gridcolor: '#f1f5f9' },
                legend: { orientation: 'h', y: 1.1 }
            };
            Plotly.newPlot('forceChart', [
                { x: times, y: sL, name: 'Left', type: 'scattergl', line: {color: '#3b82f6'} },
                { x: times, y: sR, name: 'Right', type: 'scattergl', line: {color: '#ef4444'} }
            ], forceLayout);

            // Chart 2: Deficit Mapping
            const deficitLayout = {
                margin: {t:10, b:40, l:50, r:20}, hovermode: 'x unified',
                xaxis: { title: 'Time (s)', gridcolor: '#f1f5f9' },
                yaxis: { title: 'Deficit L-R (%)', range: [-50, 50], gridcolor: '#f1f5f9' },
                shapes: [
                    { type:'rect', x0:times[0], x1:times[times.length-1], y0:-limit, y1:limit, fillcolor:'rgba(16,185,129,0.1)', line:{width:0} }
                ]
            };
            Plotly.newPlot('deficitChart', [
                { x: times, y: deficits, name: 'Deficit %', type: 'scattergl', line: {color: '#6366f1', width: 2}, fill: 'tozeroy' }
            ], deficitLayout);

            // Link Hover
            const charts = [document.getElementById('forceChart'), document.getElementById('deficitChart')];
            charts.forEach(c => {
                c.on('plotly_hover', d => {
                    let p = d.points[0].pointIndex;
                    charts.forEach(other => { if(other !== c) Plotly.Fx.hover(other, [{curveNumber:0, pointNumber:p}]); });
                });
            });
        }

        function updateUI(m) {
            document.getElementById('metrics').innerHTML = m.map(i => `
                <div class="bg-white border-l-4 ${i.val.includes('⚠️') ? 'border-orange-500' : 'border-blue-500'} p-4 rounded-xl shadow-sm">
                    <p class="text-[9px] text-slate-400 font-black uppercase mb-1">${i.label}</p>
                    <p class="text-xl font-black text-slate-800">${i.val}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
